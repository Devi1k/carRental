<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>我的预约</title>
<link href="../layui/css/layui.css" rel="stylesheet" type="text/css" />
<link href="../frame/common.css" rel="stylesheet" type="text/css" />
<link href="../css/gameInfoDetail.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="../js/jquery.min.js"></script>
<script type="text/javascript" src="../layui/layui.js"></script>
<style>
</style>
</head>
<body>
<div class="headerBox"></div>

<div class="layui-container">  
	<table class="layui-hide" id="test" lay-filter="test"></table>
	
</div>
</body>
<script type="text/javascript">
layui.use(['element',"jquery","table","form"], function(){
	var element = layui.element;
	var table = layui.table;
	var form = layui.form;
	var $ = layui.jquery;
	var modelIndex = "";
	var flag = 1;
	var uid = localStorage.getItem("uid");
	var custname = localStorage.getItem("custname");
	if(uid == ""){
		location.href = "login.html";
	}
	$("#uid").val(uid);
  var tableList = table.render({
	  elem: '#test'
	  ,url:"../../rent/loadAllRent.action"
	  ,where:{
		  identity: uid
	  },
	  page: false
	  ,parseData: function(res){ //res 即为原始返回的数据
		  console.log(res,888)
/* 		  console.log(res,888)
		res.data = res;
		res.msg = "";
		res.code = 0;
		console.log(res) */
		return {
		  "code": 0, //解析接口状态
		  "msg": res.count, //解析提示文本
		  "count": res.total, //解析数据长度
		  "data": res.data //解析数据列表
		};
	  }
	  //,toolbar: '#toolbarDemo'
	  ,title: '数据表'
	  ,cols: [[
		  {type: 'numbers', title:'序号'}   
	    ,{field:'price', title:'出租价格'}
	    ,{field:'carnumber', title:'身份证号'}
	    ,{field:'begindate', title:'开始时间'}
	    ,{field:'returndate', title:'结束时间'}
	    ,{field:'opername', title:'操作人'}
	    ,{field:'rentflag', title:'状态',
	    	templet: function(d){
	    		return d.rentflag == 0 ? "未归还" : "已归还";
	    	}
	    }
	    ,{field:'acceptid', title:'操作',width:150,
	    	templet: function(d){
	    		if(d.rentflag == 0){
		    		var html = '<a class="layui-btn layui-btn-danger layui-btn-xs deleteBtn" lay-event="del">归还</a>';
		    		return html;
	    		}else{
	    			return "";
	    		}
	         }
	   	}
	  ]]
	});
  
	  var tableData = table.on('tool(test)', function(obj){
		  var d = obj.data;
		  console.log(d)
		   if(obj.event == "del"){
			   rentCar(d);
		  }
	});


	 function rentCar(d){
		 var day = DateMinus(d.begindate,dateToString(new Date()),2);
		 var money = parseInt(day) * d.price;
		 var p = {
			 checkid:new Date().getTime(),
			 rentid: d.rentid,
			 opername: custname,
			 problem: "无",
			 checkdesc: "无",
			 paymoney: 0,
			 checkdate: dateToString(new Date(),1)
		 }
		 layer.confirm('你需支付的总费用为：'+money+'元', {icon: 3, title:'提示'}, function(index){
			 $.post("../../check/saveCheck.action",p,function(msg){
				layer.msg("支付成功！");
			 	table.reload("test" );
			 });
		 	layer.close(index);
		});	
	 }
	 
	//获取当前系统时间转换
	 function dateToString(now,flag){
	 	var year = now.getFullYear();
	 	var month =(now.getMonth() + 1).toString();
	 	var day = (now.getDate()).toString();
	 	var hour = (now.getHours()).toString();
	 	var minute = (now.getMinutes()).toString();
	 	var second = (now.getSeconds()).toString();
	 	if (month.length == 1) {
	 		month = "0" + month;
	 	}
	 	if (day.length == 1) {
	 		day = "0" + day;
	 	}
	 	if (hour.length == 1) {
			hour = "0" + hour;
		}
		if (minute.length == 1) {
			minute = "0" + minute;
		}
		if (second.length == 1) {
			second = "0" + second;
		}
		var dateTime = year + "-" + month + "-" + day;
		if(flag == 1){
			dateTime = year + "-" + month + "-" + day +" "+ hour +":"+minute+":"+second;
		}
		return dateTime;
		 
	  }
	
	 function DateMinus(date1,date2){//date1:小日期   date2:大日期
	        var sdate = new Date(date1);
	        var now = new Date(date2);
	        var days = now.getTime() - sdate.getTime();
	        var day = Math.floor(days / (1000 * 60 * 60 * 24) * 100) / 100;
	        return day;
	    }
	 
	 $(".headerBox").load("common/header.html");
	 setInterval(function(){
		$(".myRent").addClass("layui-this");
	  },200);
});
</script>
</html>